diff -durpN php-7.2.34.old/ext/session/mod_files.c php-7.2.34/ext/session/mod_files.c
--- php-7.2.34.old/ext/session/mod_files.c	2020-09-30 07:15:52.000000000 +0200
+++ php-7.2.34/ext/session/mod_files.c	2024-05-13 11:48:35.747149137 +0200
@@ -284,8 +284,7 @@ static int ps_files_write(ps_files *data
 static int ps_files_cleanup_dir(const char *dirname, zend_long maxlifetime)
 {
 	DIR *dir;
-	char dentry[sizeof(struct dirent) + MAXPATHLEN];
-	struct dirent *entry = (struct dirent *) &dentry;
+	struct dirent *entry;
 	zend_stat_t sbuf;
 	char buf[MAXPATHLEN];
 	time_t now;
@@ -312,7 +311,7 @@ static int ps_files_cleanup_dir(const ch
 	memcpy(buf, dirname, dirname_len);
 	buf[dirname_len] = PHP_DIR_SEPARATOR;
 
-	while (php_readdir_r(dir, (struct dirent *) dentry, &entry) == 0 && entry) {
+	while ((entry = readdir(dir))) {
 		/* does the file start with our prefix? */
 		if (!strncmp(entry->d_name, FILE_PREFIX, sizeof(FILE_PREFIX) - 1)) {
 			size_t entry_len = strlen(entry->d_name);
diff -durpN php-7.2.34.old/main/php_reentrancy.h php-7.2.34/main/php_reentrancy.h
--- php-7.2.34.old/main/php_reentrancy.h	2020-09-30 07:15:50.000000000 +0200
+++ php-7.2.34/main/php_reentrancy.h	2024-05-13 11:48:35.747149137 +0200
@@ -51,13 +51,6 @@
 
 BEGIN_EXTERN_C()
 
-#if defined(HAVE_POSIX_READDIR_R)
-#define php_readdir_r readdir_r
-#else
-PHPAPI int php_readdir_r(DIR *dirp, struct dirent *entry,
-		struct dirent **result);
-#endif
-
 #if !defined(HAVE_LOCALTIME_R) && defined(HAVE_LOCALTIME)
 #define PHP_NEED_REENTRANCY 1
 PHPAPI struct tm *php_localtime_r(const time_t *const timep, struct tm *p_tm);
diff -durpN php-7.2.34.old/main/php_scandir.c php-7.2.34/main/php_scandir.c
--- php-7.2.34.old/main/php_scandir.c	2020-09-30 07:15:50.000000000 +0200
+++ php-7.2.34/main/php_scandir.c	2024-05-13 11:50:13.921116585 +0200
@@ -61,8 +61,7 @@ PHPAPI int php_scandir(const char *dirna
 	struct dirent **vector = NULL;
 	int vector_size = 0;
 	int nfiles = 0;
-	char entry[sizeof(struct dirent)+MAXPATHLEN];
-	struct dirent *dp = (struct dirent *)&entry;
+	struct dirent *dp;
 
 	if (namelist == NULL) {
 		return -1;
@@ -72,7 +71,7 @@ PHPAPI int php_scandir(const char *dirna
 		return -1;
 	}
 
-	while (!php_readdir_r(dirp, (struct dirent *)entry, &dp) && dp) {
+	while ((dp = readdir(dirp))) {
 		int dsize = 0;
 		struct dirent *newdp = NULL;
 
diff -durpN php-7.2.34.old/main/reentrancy.c php-7.2.34/main/reentrancy.c
--- php-7.2.34.old/main/reentrancy.c	2020-09-30 07:15:50.000000000 +0200
+++ php-7.2.34/main/reentrancy.c	2024-05-13 11:52:09.271253295 +0200
@@ -123,54 +123,6 @@ PHPAPI struct tm *php_gmtime_r(const tim
 
 #endif /* BEOS */
 
-#if !defined(HAVE_POSIX_READDIR_R)
-
-PHPAPI int php_readdir_r(DIR *dirp, struct dirent *entry,
-		struct dirent **result)
-{
-#if defined(HAVE_OLD_READDIR_R)
-	int ret = 0;
-
-	/* We cannot rely on the return value of readdir_r
-	   as it differs between various platforms
-	   (HPUX returns 0 on success whereas Solaris returns non-zero)
-	 */
-	entry->d_name[0] = '\0';
-	readdir_r(dirp, entry);
-
-	if (entry->d_name[0] == '\0') {
-		*result = NULL;
-		ret = errno;
-	} else {
-		*result = entry;
-	}
-	return ret;
-#else
-	struct dirent *ptr;
-	int ret = 0;
-
-	local_lock(READDIR_R);
-
-	errno = 0;
-
-	ptr = readdir(dirp);
-
-	if (!ptr && errno != 0)
-		ret = errno;
-
-	if (ptr)
-		memcpy(entry, ptr, sizeof(*ptr));
-
-	*result = ptr;
-
-	local_unlock(READDIR_R);
-
-	return ret;
-#endif
-}
-
-#endif
-
 #if !defined(HAVE_LOCALTIME_R) && defined(HAVE_LOCALTIME)
 
 PHPAPI struct tm *php_localtime_r(const time_t *const timep, struct tm *p_tm)
diff -durpN php-7.2.34.old/main/streams/plain_wrapper.c php-7.2.34/main/streams/plain_wrapper.c
--- php-7.2.34.old/main/streams/plain_wrapper.c	2020-09-30 07:15:50.000000000 +0200
+++ php-7.2.34/main/streams/plain_wrapper.c	2024-05-13 11:48:39.433185461 +0200
@@ -893,16 +893,15 @@ PHPAPI php_stream_ops	php_stream_stdio_o
 static size_t php_plain_files_dirstream_read(php_stream *stream, char *buf, size_t count)
 {
 	DIR *dir = (DIR*)stream->abstract;
-	/* avoid libc5 readdir problems */
-	char entry[sizeof(struct dirent)+MAXPATHLEN];
-	struct dirent *result = (struct dirent *)&entry;
+	struct dirent *result;
 	php_stream_dirent *ent = (php_stream_dirent*)buf;
 
 	/* avoid problems if someone mis-uses the stream */
 	if (count != sizeof(php_stream_dirent))
 		return 0;
 
-	if (php_readdir_r(dir, (struct dirent *)entry, &result) == 0 && result) {
+	result = readdir(dir);
+	if (result) {
 		PHP_STRLCPY(ent->d_name, result->d_name, sizeof(ent->d_name), strlen(result->d_name));
 		return sizeof(php_stream_dirent);
 	}
diff -durpN php-7.2.34.old/win32/readdir.c php-7.2.34/win32/readdir.c
--- php-7.2.34.old/win32/readdir.c	2020-09-30 07:15:55.000000000 +0200
+++ php-7.2.34/win32/readdir.c	2024-05-13 11:48:39.433185461 +0200
@@ -127,46 +127,6 @@ struct dirent *readdir(DIR *dp)
 	return &(dp->dent);
 }/*}}}*/
 
-int readdir_r(DIR *dp, struct dirent *entry, struct dirent **result)
-{/*{{{*/
-	char *_tmp;
-	size_t reclen;
-
-	if (!dp || dp->finished) {
-		*result = NULL;
-		return 0;
-	}
-
-	if (dp->offset != 0) {
-		if (FindNextFileW(dp->handle, &(dp->fileinfo)) == 0) {
-			dp->finished = 1;
-			*result = NULL;
-			return 0;
-		}
-	}
-
-	_tmp = php_win32_cp_conv_w_to_any(dp->fileinfo.cFileName, PHP_WIN32_CP_IGNORE_LEN, &reclen);
-	if (!_tmp) {
-		/* wide to utf8 failed, should never happen. */
-		result = NULL;
-		return 0;
-	}
-	memmove(dp->dent.d_name, _tmp, reclen + 1);
-	free(_tmp);
-	dp->dent.d_reclen = (unsigned short)reclen;
-
-	dp->offset++;
-
-	dp->dent.d_ino = 1;
-	dp->dent.d_off = dp->offset;
-
-	memcpy(entry, &dp->dent, sizeof(*entry));
-
-	*result = &dp->dent;
-
-	return 0;
-}/*}}}*/
-
 int closedir(DIR *dp)
 {/*{{{*/
 	if (!dp)
diff -durpN php-7.2.34.old/win32/readdir.h php-7.2.34/win32/readdir.h
--- php-7.2.34.old/win32/readdir.h	2020-09-30 07:15:55.000000000 +0200
+++ php-7.2.34/win32/readdir.h	2024-05-13 11:48:39.433185461 +0200
@@ -15,8 +15,6 @@ extern "C" {
 
 #include "ioutil.h"
 
-#define php_readdir_r readdir_r
-
 /* struct dirent - same as Unix */
 struct dirent {
 	long d_ino;					/* inode (always 1 in WIN32) */
@@ -43,7 +41,6 @@ typedef struct DIR_W32 DIR;
 /* Function prototypes */
 DIR *opendir(const char *);
 struct dirent *readdir(DIR *);
-int readdir_r(DIR *, struct dirent *, struct dirent **);
 int closedir(DIR *);
 int rewinddir(DIR *);
 
